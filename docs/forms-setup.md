# Формы: настройка и использование

## Архитектура

- **Основная форма** (`.contact-form`) — дефолт на всех страницах, стиль как на главной
- **Попап** — глобальный, по кнопке «Заказать звонок» в шапке/подвале
- **4 резервных варианта** — менеджер выбирает через ACF на конкретной странице

---

## Установка на прод (пошагово)

### Шаг 1 — Залить тему

Скопировать папку `wp-content/themes/gociss-theme/` на сервер (или `git pull`, если настроен).

### Шаг 2 — Убедиться что плагины активны

- **Contact Form 7** — создание и обработка форм
- **Advanced Custom Fields (ACF)** — поля управления на страницах

### Шаг 3 — Создать формы в CF7

Открыть **Контакты → Добавить новую**. Каждый вариант формы — это отдельная форма в CF7 со своим шорткодом.

- **Обязательные (минимум):** основная + попап — без них сайт без форм
- **Резервные (по необходимости):** остальные 4 — создаёшь когда нужен конкретный вариант на странице. Пока форма не создана — вместо неё выводится подсказка для админа

#### Основная форма

```
[hidden form_type "default"]
[hidden page_url default:get]
[hidden page_title default:post_title]

[text* your-name placeholder "Ваше имя"]
[tel* your-phone placeholder "Телефон"]
[email your-email placeholder "E-mail"]

[textarea your-message placeholder "Сообщение"]

[submit "Отправить заявку"]
```

#### Попап

```
[hidden form_type "popup"]
[hidden page_url default:get]
[hidden page_title default:post_title]

[text* your-name placeholder "Ваше имя"]
[tel* your-phone placeholder "Телефон"]
[submit "ОТПРАВИТЬ"]

<p class="form-acceptance">При нажатии на кнопку "Отправить" Вы даёте своё согласие на <a href="/privacy-policy/" target="_blank">обработку персональных данных</a></p>
```

#### Консультация (резервный)

```
[hidden form_type "consult"]
[hidden page_url default:get]
[hidden page_title default:post_title]

<div class="form-row">
[text* your-name placeholder "Контактное лицо"]
[tel* your-phone placeholder "Телефон"]
[submit "ОТПРАВИТЬ"]
</div>

<p class="form-acceptance">При нажатии на кнопку "Отправить" Вы даёте своё согласие на <a href="/privacy-policy/" target="_blank">обработку персональных данных</a></p>
```

#### Остались вопросы (резервный)

```
[hidden form_type "callback"]
[hidden page_url default:get]
[hidden page_title default:post_title]

<div class="form-row">
[text* your-name placeholder "Контактное лицо"]
[tel* your-phone placeholder "Телефон"]
[submit "ОТПРАВИТЬ"]
</div>

<p class="form-acceptance">При нажатии на кнопку "Отправить" Вы даёте своё согласие на <a href="/privacy-policy/" target="_blank">обработку персональных данных</a></p>
```

#### Онлайн заявка вертикальная (резервный)

```
[hidden form_type "vertical"]
[hidden page_url default:get]
[hidden service_name]

[text* your-name placeholder "Ваше имя"]
[tel* your-phone placeholder "Телефон +7 (___) ___-__-__"]
[submit "ОТПРАВИТЬ"]

<p class="form-acceptance">При нажатии на кнопку "Отправить" Вы даёте своё согласие на <a href="/privacy-policy/" target="_blank">обработку персональных данных</a></p>
```

#### Онлайн заявка горизонтальная (резервный)

```
[hidden form_type "horizontal"]
[hidden page_url default:get]
[hidden service_name]

<div class="form-row">
[text* your-name placeholder "Ваше имя"]
[tel* your-phone placeholder "Телефон"]
[submit "ОТПРАВИТЬ"]
</div>
```

> **Важно:** НЕ добавлять `[text service_display ...]` в шаблоны — название услуги выводится PHP-шаблоном автоматически.

### Шаг 4 — Вставить шорткоды в настройки темы

Перейти в **Внешний вид → Формы** и вставить шорткоды CF7 (вида `[contact-form-7 id="123" title="Основная"]`):

| Поле | Что вставить |
|---|---|
| **Основная форма** | Шорткод основной формы (обязательно) |
| **Попап** | Шорткод попапа (обязательно) |
| **Фото оператора (попап)** | URL картинки (опционально) |
| **Готовы проконсультировать** | Шорткод формы консультации |
| **Фото консультанта** | URL картинки |
| **Подпись под фото** | Текст, напр. "Специалист-консультант" |
| **Остались вопросы** | Шорткод формы обратного звонка |
| **Онлайн заявка (верт.)** | Шорткод вертикальной формы |
| **Онлайн заявка (гор.)** | Шорткод горизонтальной формы |

### Шаг 5 — Настроить письма в CF7

В каждой форме CF7 перейти на вкладку **«Письмо»** и заполнить поля. Шаблоны ниже.

#### Письмо: Основная форма

```
Кому: admin@gociss.ru
Тема: Заявка с сайта — [your-name]
От: gociss.ru <noreply@gociss.ru>
Доп. заголовки: Reply-To: [your-email]

Тело:
Новая заявка с сайта gociss.ru

Имя: [your-name]
Телефон: [your-phone]
E-mail: [your-email]
Сообщение:
[your-message]

---
Тип формы: [form_type]
Страница: [page_title]
URL: [page_url]
```

#### Письмо: Попап

```
Кому: admin@gociss.ru
Тема: Обратный звонок — [your-name]
От: gociss.ru <noreply@gociss.ru>

Тело:
Запрос обратного звонка

Имя: [your-name]
Телефон: [your-phone]

---
Тип формы: [form_type]
Страница: [page_title]
URL: [page_url]
```

#### Письмо: Консультация / Остались вопросы

```
Кому: admin@gociss.ru
Тема: Запрос консультации — [your-name]
От: gociss.ru <noreply@gociss.ru>

Тело:
Запрос консультации с сайта

Имя: [your-name]
Телефон: [your-phone]

---
Тип формы: [form_type]
Страница: [page_title]
URL: [page_url]
```

#### Письмо: Онлайн заявка (вертикальная / горизонтальная)

```
Кому: admin@gociss.ru
Тема: Онлайн заявка — [your-name]
От: gociss.ru <noreply@gociss.ru>

Тело:
Онлайн заявка с сайта

Имя: [your-name]
Телефон: [your-phone]
Услуга: [service_name]

---
Тип формы: [form_type]
URL: [page_url]
```

> **Примечание:** `admin@gociss.ru` — заменить на реальный email получателя. Можно указать несколько через запятую.

### Шаг 6 — Проверить

1. Открыть сайт, отправить тестовую заявку через основную форму
2. Нажать «Заказать звонок» — проверить попап
3. В консоли браузера (F12) должно появиться `Метрика: цель отправлена - ...`
4. Проверить что письмо дошло на email

---

## Как менеджер меняет форму на странице

1. Открыть страницу/услугу в редакторе
2. Найти блок ACF **«Форма обратной связи»**
3. В поле **«Вариант формы»** выбрать:
   - **По умолчанию** — основная форма (как на главной)
   - **Готовы проконсультировать** — блок с фото консультанта
   - **Остались вопросы** — компактная горизонтальная
   - **Онлайн заявка (вертикальная)** — карточка с тенью
   - **Онлайн заявка (горизонтальная)** — синий фон
4. При выборе «По умолчанию» — можно переопределить заголовок, описание и CF7-шорткод
5. Сохранить страницу

ACF-поля доступны на всех страницах (`page`) и услугах (`gociss_service`).

---

## Шорткоды для вставки в контент

Можно вставить форму прямо в тело страницы через редактор:

```
[gociss_form_consult]
[gociss_form_callback]
[gociss_form_vertical]
[gociss_form_horizontal]
```

С указанием услуги: `[gociss_form_vertical service_name="ISO 9001"]`

---

## Яндекс.Метрика

### Как работает

Интеграция полностью автоматическая. В `main.js` функция `initFormsMetrika()`:

1. Слушает событие `wpcf7mailsent` — срабатывает когда CF7 **успешно отправил** письмо
2. Определяет тип формы по CSS-классу обёртки (`.form-popup__form`, `.form-consult__form` и т.д.)
3. Если по классу не нашёл — проверяет скрытое поле `form_type` внутри формы
4. Вызывает `ym(32620105, 'reachGoal', 'название-цели')`

### Что нужно для работы

- Счётчик Яндекс.Метрики с ID **32620105** должен быть подключён на сайте
- В интерфейсе Метрики (metrika.yandex.ru) должны быть созданы цели с идентификаторами из таблицы ниже

### Цели

| Форма | Идентификатор цели | Номер цели |
|---|---|---|
| Попап «Есть вопросы» | `est-voprosy-knopka-v-shapke-podvale` | 362600350 |
| Готовы проконсультировать | `est-voprosy-skvoznaya` | 362578299 |
| Остались вопросы | `ostalis-voprosy-skvoznaya` | 362593182 |
| Онлайн заявка (верт.) | `onlayn-zayavka-vertikalnaya` | 362593580 |
| Онлайн заявка (гор.) | `onlayn-zayavka-gorizontalnaya` | 362593670 |

### Как проверить

1. Открыть сайт с включённой консолью (F12 → Console)
2. Отправить любую форму
3. В консоли должно появиться: `Метрика: цель отправлена - название-цели`
4. Если Метрика не подключена, будет: `Метрика не загружена, цель: название-цели`

---

## Файлы

| Файл | Что делает |
|---|---|
| `template-parts/form.php` | Диспетчер: проверяет ACF-вариант → рендерит нужный шаблон |
| `template-parts/forms/popup-callback.php` | Попап (подключён в `footer.php`, глобально) |
| `template-parts/forms/consult.php` | Вариант «Готовы проконсультировать» |
| `template-parts/forms/callback-simple.php` | Вариант «Остались вопросы» |
| `template-parts/forms/application-vertical.php` | Вариант «Онлайн заявка» вертикальная |
| `template-parts/forms/application-horizontal.php` | Вариант «Онлайн заявка» горизонтальная |
| `inc/forms-options-page.php` | Настройки форм (Внешний вид → Формы) + регистрация шорткодов |
| `inc/acf-fields.php` | ACF-поля (группа `group_gociss_form`) |
| `assets/css/style.css` | CSS всех вариантов форм |
| `assets/js/main.js` | JS попапа + интеграция Метрики |
